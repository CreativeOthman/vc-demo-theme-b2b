{%- if collection.all_tags.size > 0 -%}            
    {%- comment -%}
        Loop through tag categories
    {%- endcomment -%}
    {%- for cat_item in collection.all_tags.groups -%}
        {%- comment -%}
            Ignore if tag category is empty
        {%- endcomment -%}
        {%- unless cat_item == '' -%}
            {%- capture group_label %}{% if cat_item == 'price' %}{{ 'tags.price.label' | t }}{% else %}{{ cat_item }}{% endif %}{%- endcapture -%}
            <div class="panel-default" uib-accordion-group heading="{{ group_label | escape }}" template-url="collection-sidebar-default-group.html" is-open="true">
                <ol class="list-unstyled">
                    {%- comment -%}
                        Loop through collection tags
                    {%- endcomment -%}
                    {%- for custom_tag in collection.all_tags -%}
                        {%- if custom_tag.group_label == cat_item -%}
                            {%- comment -%}
                                Strip out tag category prefix and add/remove link for tag filtering
                            {%- endcomment -%}
                            {%- include 'tag-label', tag: custom_tag -%}
                            {% if current_tags contains custom_tag %}
                                {% assign is_active = true %}
                            {% else %}
                                {% assign is_active = false %}
                            {% endif %}
                            {%- if is_active -%}
                                <li class="checkbox advanced-filter active-filter" data-group="{{ cat_item }}" data-handle="{{ custom_tag.id | handleize }}">
                            {%- else -%}
                                <li class="checkbox advanced-filter" data-group="{{ cat_item }}">
                            {%- endif -%}
                                <label>
                                    <input type="checkbox" ng-checked="{{ is_active }}">
                                    {% capture tag_link_text %}{{ tag_label }} ({{custom_tag.count}}){% endcapture %}
                                    {% capture tag_link_elements %}
                                        <span class="switch"></span>
                                        <span class="name">{{ tag_label }} <span class="count">({{ custom_tag.count }})</span></span>
                                    {% endcapture %}
                                    {% if is_active %}
                                        {{ tag_label | link_to_remove_tag: custom_tag | replace: tag_link_text, tag_link_elements }}
                                    {% else %}
                                        {{ tag_label | link_to_add_tag: custom_tag | replace: tag_link_text, tag_link_elements }}                                            
                                    {% endif %}
                                </label>
                            </li>
                        {%- endif -%}
                    {%- endfor -%}
                </ol>
            </div>
        {%- endunless -%}
    {%- endfor -%}
    <script>
    $(function() {
        var currentTags = '{{ current_tags }}',
                filters = $('.advanced-filter'),
                activeTag,
                activeHandle;

        filters.each(function() {
            var el = $(this),
                    group = el.data('group'),
                    isActive = el.hasClass('active-filter');
        });

        filters.on('click', function(e) {
            var el = $(this),
                    group = el.data('group'),
                    url = el.find('a').attr('href');

            // Continue as normal if we're clicking on the active link
            if ( el.hasClass('active-filter') ) {
                return;
            }

            // Get active group link (unidentified if there isn't one)
            activeTag = $('.active-filter[data-group="'+ group +'"]');

            // If a tag from this group is already selected, remove it from the new tag's URL and continue
            if ( activeTag && activeTag.data('group') === group ) {
                e.preventDefault();
                activeHandle = activeTag.data('handle') + '+';

                // Create new URL without the currently active handle
                url = url.replace(activeHandle, '');

                window.location = url;
            }
        });
    });
    </script>
{%- endif -%}
