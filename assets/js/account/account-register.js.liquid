var storefrontApp = angular.module('storefrontApp');

storefrontApp.controller('accountRegisterController', ['$q', '$scope', 'storefrontApp.mainContext', 'storefront.corporateAccountApi', 'storefront.corporateRegisterApi', 'loadingIndicatorService', function ($q, $scope, mainContext, corporateAccountApi, corporateRegisterApi, loader) {
    $scope.loader = loader;
    $scope.memberComponent = null;
    $scope.newMember = null;

    $scope.registerMemberFieldsConfig = [
        {
            field: 'CompanyName',
            disabled: false,
            visible: true,
            required: true
        },
        {
            field: 'UserName',
            disabled: false,
            visible: true,
            required: true
        },
        {
            field: 'Password',
            disabled: false,
            visible:  true,
            required: true
        }
    ];

    function getParams() {
        var params = window.location.search.substring(1).split("&"), result = {}, param, i;
        for (i in params) {
            if (params.hasOwnProperty(i)) {
                if (params[i] === "") continue;

                param = params[i].split("=");
                result[decodeURIComponent(param[0])] = decodeURIComponent(param[1]);
            }
        }
        return result;
    }

    $scope.init = function (storeId) {
        $scope.newMember = {};
        $scope.newMember.storeId = storeId;

        $scope.complete = false;

        var invite = getParams().invite;
        if (invite) {
            $scope.registerMemberFieldsConfig[0] = {
                field: 'CompanyName',
                disabled: false,
                visible: false,
                required: false
            };
            
            $scope.newMember.invite = invite;
            $scope.loader.wrapLoading(function() {
                return corporateAccountApi.getCompanyMember({ id: invite }).$promise
                    .then(function(result) {
                        if (!result.id) {
                            $scope.error = "{{ 'customer.register.registration_invite_revoked_text' | t }}";
                            return $q.reject("Invite revoked");
                        }
                        if (result.securityAccounts && result.securityAccounts.length) {
                            $scope.error = "{{ 'customer.register.registration_invite_already_used_text' | t }}";
                            return $q.reject("Invite already used");
                        }
                        $scope.newMember.companyId = result.organizations[0];
                        $scope.newMember.email = result.emails[0];
                    })
                    .then(function () {
                        return corporateAccountApi.getCompanyById({ id: $scope.newMember.companyId }, function(result) {
                            $scope.newMember.companyName = result.name;
                        }).$promise;
                    });
            });
        }
    };

    $scope.register = function () {
        $scope.error = null;

        if (this.memberComponent.validate()) {
            if ($scope.newMember.invite) {
                $scope.loader.wrapLoading(function () {
                    return corporateRegisterApi.registerByInvite({ invite: $scope.newMember.invite }, $scope.newMember, function (result) {
                        if (result.message) {
                            $scope.error = result.message;
                        } else {
                            $scope.complete = true;
                        }
                    }).$promise;
                });
            } else {
                $scope.loader.wrapLoading(function() {
                    return corporateRegisterApi.register($scope.newMember, function(result) {
                        if (result.message) {
                            $scope.error = result.message;
                        } else {
                            $scope.complete = true;
                        }
                    }).$promise;
                });
            }
        }
    };
}]);